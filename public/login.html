<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login — ProWriter Solutions</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --accent:#007bff;
      --danger:#dc3545;
      --muted:#6b7280;
      --radius:12px;
      --shadow: 0 6px 24px rgba(15,23,42,0.08);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 400px at 10% 10%, rgba(0,123,255,0.06), transparent 8%),
        radial-gradient(1000px 300px at 95% 90%, rgba(220,53,69,0.03), transparent 8%),
        var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
    }

    .login-page { width:100%; max-width:420px; }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:28px;
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04);
    }

    .card h1{
      margin:0 0 18px 0;
      font-size:20px;
      color:#111827;
      text-align:center;
    }

    form{margin-top:6px}
    input[type="email"],
    input[type="password"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid #e6e9ef;
      background:#fbfdff;
      outline:none;
      font-size:14px;
      margin:8px 0;
      transition:box-shadow .12s, border-color .12s;
    }
    input:focus{
      border-color:var(--accent);
      box-shadow:0 6px 18px rgba(0,123,255,0.08);
    }

    button[type="submit"]{
      width:100%;
      padding:12px 14px;
      margin-top:10px;
      border-radius:10px;
      border:none;
      background:linear-gradient(180deg,var(--accent),#0062d6);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:15px;
      transition:transform .08s ease, box-shadow .08s;
    }
    button[type="submit"]:active{ transform:translateY(1px) }
    button[type="submit"]:hover{ box-shadow:0 6px 18px rgba(0,123,255,0.12) }

    #message{
      margin:12px 0 0 0;
      font-size:13px;
      color:var(--muted);
      min-height:18px;
      text-align:center;
      word-break:break-word;
    }

    .links{ font-size:13px; color:var(--muted); text-align:center; margin-top:12px }
    .links a{ color:var(--accent); text-decoration:none; font-weight:600 }
    .links a:hover{ text-decoration:underline }

    @media (prefers-reduced-motion: reduce){
      *{transition:none!important}
    }

    /* small focus visible helper */
    input:focus, button:focus { outline: 3px solid rgba(0,123,255,0.12); outline-offset:2px; }
  </style>
</head>
<body>
  <main class="login-page">
    <div class="card" role="region" aria-labelledby="loginTitle">
      <h1 id="loginTitle">Login to ProWriter</h1>

      <form id="loginForm" autocomplete="on" novalidate>
        <input type="email" id="email" placeholder="Email" required autocomplete="email" inputmode="email" />
        <input type="password" id="password" placeholder="Password" required autocomplete="current-password" />
        <button type="submit">Login</button>
      </form>

      <p id="message" role="status" aria-live="polite"></p>

      <section id="verifySection" style="margin-top:14px;">
        <h3 style="margin:6px 0 8px 0;font-size:15px;">Have a verification code?</h3>
        <input type="email" id="verifyEmail" placeholder="Email (same as registration)" />
        <input type="text" id="verifyCode" placeholder="Enter verification code" />
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="verifyBtn" style="flex:1;">Verify Code</button>
          <button id="resendBtn" type="button" style="flex:1;background:#ffc107;color:#000;">Resend Code</button>
        </div>
      </section>
      <p class="links">Don't have an account? <a href="register.html">Register here</a></p>
    </div>
  </main>

  <script>
    const form = document.getElementById('loginForm');
    const message = document.getElementById('message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      message.textContent = 'Checking credentials...';

      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      try {
        const apiUrl = (window.location && window.location.origin && window.location.origin.startsWith('http'))
          ? `${window.location.origin}/api/login`
          : 'http://localhost:3000/api/login';

        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        let payload = null;
        try {
          payload = await res.json();
        } catch (parseErr) {
          payload = { message: res.statusText || 'Server error' };
        }

        if (!res.ok) {
          message.textContent = payload.message || '⚠️ Login failed.';
          return;
        }

        const user = payload.user || payload;
        const token = payload.token || null;
        message.textContent = '✅ Login successful! Redirecting...';
        localStorage.setItem('user', JSON.stringify(user));
        if (token) localStorage.setItem('token', token);

        setTimeout(() => {
          if (user.role === 'admin') {
            window.location.href = 'admin-dashboard.html';
          } else if (user.role === 'writer' || user.role === 'employee') {
            window.location.href = 'writer-dashboard.html';
          } else {
            window.location.href = 'client-dashboard.html';
          }
        }, 800);
      } catch (err) {
        console.error(err);
        message.textContent = `⚠️ ${err.message || 'Network or server error.'}`;
      }
    });

    // Verification handlers
    const verifyEmailInput = document.getElementById('verifyEmail');
    const verifyCodeInput = document.getElementById('verifyCode');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');

    // Prefill verify email when focus on verify email input
    verifyEmailInput.addEventListener('focus', () => {
      const e = document.getElementById('email').value.trim();
      if (e) verifyEmailInput.value = e;
    });

    verifyBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const email = (verifyEmailInput.value || '').trim().toLowerCase();
      const code = (verifyCodeInput.value || '').trim();
      if (!email || !code) {
        message.textContent = 'Please provide email and code.';
        return;
      }

      try {
        message.textContent = 'Verifying...';
        const res = await fetch('/api/verify-email', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email, code })
        });
        const payload = await res.json();
        if (!res.ok) {
          message.textContent = payload.message || 'Verification failed.';
          return;
        }
        message.textContent = '✅ Email verified. You can now log in.';
      } catch (err) {
        console.error(err);
        message.textContent = `Error: ${err.message || 'Network error'}`;
      }
    });

    resendBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const email = (verifyEmailInput.value || document.getElementById('email').value || '').trim().toLowerCase();
      if (!email) { message.textContent = 'Enter an email to resend code.'; return; }
      try {
        message.textContent = 'Resending code...';
        const res = await fetch('/api/resend-verification', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        const payload = await res.json();
        if (!res.ok) { message.textContent = payload.message || 'Failed to resend code.'; return; }
        message.textContent = 'Verification code resent. Check server logs or your email.';
      } catch (err) {
        console.error(err);
        message.textContent = `Error: ${err.message || 'Network error'}`;
      }
    });
  </script>
</body>
</html>
