<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Dashboard | ProWriter Solutions</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    main.dashboard {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 { text-align: center; color: #333; }

    #logoutBtn {
      background: #dc3545;
      float: right;
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: -10px;
    }
    #logoutBtn:hover { background: #b52d3a; }

    form {
      margin-top: 30px;
      background: #f9fafb;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }

    input, textarea, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    button:hover { background: #0056b3; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background: #007bff;
      color: white;
    }

    tr:nth-child(even) { background: #f9f9f9; }

    .status {
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: bold;
      color: white;
    }

    .pending { background: orange; }
    .inprogress { background: #007bff; }
    .completed { background: green; }

    td a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }

    td a:hover { text-decoration: underline; }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 5px;
    }

    .delete-btn:hover { background: #b52d3a; }

    #welcome {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .noOrders {
      text-align: center;
      color: gray;
      padding: 15px;
    }

    /* small accessibility helper */
    .sr-only { position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <main class="dashboard">
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <h1>Client Dashboard</h1>
      <div class="profile" style="position:relative;">
        <button id="profileBtn" title="Profile" style="width:40px;height:40px;border-radius:50%;border:none;background:#007bff;color:#fff;font-weight:bold;cursor:pointer;">C</button>
        <div id="profileDropdown" style="display:none;position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);min-width:160px;z-index:1000;overflow:hidden;">
          <div id="profileDetailsBtn" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;">Details</div>
          <div id="profileLogout" style="padding:10px 12px;cursor:pointer;color:#fff;background:crimson;text-align:center;">Logout</div>
        </div>
      </div>
    </header>
    <p id="welcome" aria-live="polite"></p>

    <!-- âœï¸ NEW PROJECT FORM -->
    <section>
      <h2>Submit New Project</h2>
      <form id="projectForm">
        <label class="sr-only" for="title">Project Title</label>
        <input type="text" id="title" placeholder="Project Title" required>
        <label class="sr-only" for="description">Project Description</label>
        <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
          <label><input type="radio" name="entryType" id="opt_desc" value="desc" checked> Describe project</label>
          <label><input type="radio" name="entryType" id="opt_upload" value="upload"> Upload guide</label>
        </div>
        <textarea id="description" placeholder="Project Description" required></textarea>
        <input type="file" id="guide" accept=".pdf,.doc,.docx,.txt,.odt" style="display:none"> 
        <label class="sr-only" for="submission_date">Submission Date</label>
        <input type="date" id="submission_date" required>
        <label class="sr-only" for="expected_ready">Expected Ready Date & Time</label>
        <input type="datetime-local" id="expected_ready" required>
        <button type="submit">Submit Project</button>
      </form>
    </section>

    <hr style="margin: 30px 0;">

    <!-- ðŸ“œ LIST OF CLIENT PROJECTS -->
    <section>
      <h2>My Submitted Projects</h2>
      <table id="projectsTable" aria-describedby="tableDesc">
        <caption id="tableDesc" class="sr-only">List of projects submitted by the logged-in client</caption>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Submitted</th>
            <th>Expected</th>
            <th>Status</th>
            <th>Writer</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Preview Modal (restricted for pre-delivery) -->
  <div id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewTitle" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:9999;">
    <div id="previewInner" style="position:relative; background:#fff; padding:12px; width:90%; max-width:1000px; height:80vh; border-radius:8px; overflow:hidden;">
      <h3 id="previewTitle" class="sr-only">Submission preview</h3>
      <button id="closePreview" style="position:absolute; right:12px; top:12px; background:#dc3545; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">Close</button>
      <button id="openPreviewTab" style="position:absolute; right:200px; top:12px; background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">Open in new tab</button>
      <button id="payBtn" style="position:absolute; right:120px; top:12px; background:#28a745; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">Pay to unlock download</button>
      <div id="previewHolder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
        <div id="previewContent" style="width:100%; height:100%; position:relative;"></div>
      </div>
      <div id="previewNotice" style="position:absolute; left:12px; bottom:12px; color:#333; font-size:13px;"></div>
    </div>
  </div>

    <!-- Details Modal -->
    <div id="detailsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;">
      <div style="background:#fff; padding:16px; max-width:420px; width:90%; border-radius:8px; position:relative;">
        <button id="closeDetails" style="position:absolute; right:12px; top:12px; background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Close</button>
        <h3 style="margin-top:0;">Profile Details</h3>
        <div id="detailsBody" style="margin-top:8px; color:#333;"></div>
      </div>
    </div>

  <script>
    // basic state and DOM refs
    const user = JSON.parse(localStorage.getItem("user") || 'null');
    const welcome = document.getElementById("welcome");
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const form = document.getElementById("projectForm");
    const tableBody = document.querySelector("#projectsTable tbody");
    // default submission date to today for convenience
    const submissionDateInput = document.getElementById('submission_date');
    const guideInput = document.getElementById('guide');
    const optDesc = document.getElementById('opt_desc');
    const optUpload = document.getElementById('opt_upload');
    if (submissionDateInput && !submissionDateInput.value) {
      submissionDateInput.value = new Date().toISOString().slice(0,10);
    }

    // toggle between description and upload
    function updateEntryMode() {
      if (optUpload && optUpload.checked) {
        document.getElementById('description').disabled = true;
        document.getElementById('description').required = false;
        if (guideInput) guideInput.style.display = 'block';
      } else {
        document.getElementById('description').disabled = false;
        document.getElementById('description').required = true;
        if (guideInput) guideInput.style.display = 'none';
      }
    }
    if (optDesc) optDesc.addEventListener('change', updateEntryMode);
    if (optUpload) optUpload.addEventListener('change', updateEntryMode);
    updateEntryMode();

    // API base - allow override via window.__API_BASE__ in dev if needed
    const apiBase = (window.__API_BASE__ && String(window.__API_BASE__).trim())
      || ((window.location && window.location.origin && window.location.origin.startsWith('http')) ? window.location.origin : 'http://localhost:3000');
    const apiUrl = (path) => `${apiBase}${path}`;
    const storedToken = localStorage.getItem('token');
    // helper to include Authorization header when token available
    async function fetchApi(path, options) {
      options = options || {};
      options.headers = options.headers || {};
      if (storedToken) options.headers['Authorization'] = `Bearer ${storedToken}`;
      return fetch(apiUrl(path), options);
    }

    // helpers
    async function safeJson(res) {
      try { return await res.json(); } catch (e) { return null; }
    }
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function resolveUrl(candidate) {
      try { return new URL(candidate, apiBase).toString(); } catch(e) { return null; }
    }
    function isAllowedEmbed(url) {
      if (!url) return false;
      try {
        const u = new URL(url);
        const originOk = u.origin === window.location.origin || u.origin === new URL(apiBase).origin;
        return originOk;
      } catch (e) { return false; }
    }
    // format helpers for dates
    function fmtDate(d) {
      if (!d) return '';
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return String(d);
        return dt.toLocaleDateString();
      } catch (e) { return String(d); }
    }
    function fmtDateTime(d) {
      if (!d) return '';
      try {
        const dt = new Date(d);
        if (isNaN(dt)) return String(d);
        return dt.toLocaleString();
      } catch (e) { return String(d); }
    }

    // auth / role checks
    if (!user) {
      window.location.href = "login.html";
    } else if (!user.role || user.role !== "client") {
      // if role exists, redirect to role dashboard; otherwise force login
      if (user.role) {
        window.location.href = `${user.role}-dashboard.html`;
      } else {
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    } else {
      welcome.textContent = `Welcome, ${user.name || 'Client'}`;
    }

    // profile dropdown + logout handling
    if (profileBtn && user && user.name) {
      const initials = user.name.split(' ').map(n => n && n[0]).filter(Boolean).slice(0,2).join('').toUpperCase();
      profileBtn.textContent = initials || 'C';
    }
    function closeProfileDropdown() { if (profileDropdown) profileDropdown.style.display = 'none'; }
    profileBtn && profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!profileDropdown) return;
      profileDropdown.style.display = (profileDropdown.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', () => closeProfileDropdown());
    const profileDetailsBtn = document.getElementById('profileDetailsBtn');
    const profileLogoutBtn = document.getElementById('profileLogout');
    profileDetailsBtn && profileDetailsBtn.addEventListener('click', () => {
      const modal = document.getElementById('detailsModal');
      const body = document.getElementById('detailsBody');
      if (modal && body) {
        body.innerHTML = `\n          <p><strong>Name:</strong> ${user.name || 'â€”'}</p>\n          <p><strong>Email:</strong> ${user.email || 'â€”'}</p>\n          <p><strong>Role:</strong> ${user.role || 'â€”'}</p>\n          <p><strong>ID:</strong> ${user.id || 'â€”'}</p>\n          <p><strong>Country:</strong> ${user.country || 'â€”'}</p>\n        `;
        modal.style.display = 'flex';
      }
      closeProfileDropdown();
    });
    profileLogoutBtn && profileLogoutBtn.addEventListener('click', () => {
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // prevent overlapping loads
    let isLoadingProjects = false;
    async function loadProjects() {
      if (isLoadingProjects) return;
      isLoadingProjects = true;
      try {
        const res = await fetchApi('/api/orders');
        const data = await safeJson(res) || [];
        tableBody.innerHTML = "";
        const myProjects = Array.isArray(data) ? data.filter(p => p.client_id === user.id) : [];
        if (!myProjects.length) {
          tableBody.innerHTML = `<tr><td colspan="8" class="noOrders">No projects submitted yet</td></tr>`;
          return;
        }
        myProjects.forEach(p => {
          const tr = document.createElement('tr');

          const tdId = document.createElement('td'); tdId.textContent = p.id; tr.appendChild(tdId);
          const tdTitle = document.createElement('td'); tdTitle.textContent = p.title || ''; tr.appendChild(tdTitle);
          const tdDesc = document.createElement('td'); tdDesc.textContent = p.description || ''; tr.appendChild(tdDesc);

          const tdSubmitted = document.createElement('td'); tdSubmitted.textContent = p.submission_date ? fmtDate(p.submission_date) : ''; tr.appendChild(tdSubmitted);
          const tdExpected = document.createElement('td'); tdExpected.textContent = p.expected_ready ? fmtDateTime(p.expected_ready) : ''; tr.appendChild(tdExpected);

          const tdStatus = document.createElement('td');
          const spanStatus = document.createElement('span');
          const statusClass = p.status ? p.status.toLowerCase().replace(/\s/g, '') : 'pending';
          spanStatus.className = `status ${statusClass}`;
          spanStatus.textContent = p.status || '';
          tdStatus.appendChild(spanStatus);
          tr.appendChild(tdStatus);

          const tdWriter = document.createElement('td'); tdWriter.textContent = p.writer_name || 'Unassigned'; tr.appendChild(tdWriter);

          const tdActions = document.createElement('td');

          if (p.submission_file || p.submission_url) {
            // allow viewing client guide if present
            if (p.client_guide) {
              const viewGuideBtn = document.createElement('button');
              viewGuideBtn.type = 'button';
              viewGuideBtn.textContent = 'View Guide';
              viewGuideBtn.style.marginRight = '6px';
              viewGuideBtn.addEventListener('click', () => {
                const u = resolveUrl(p.client_guide) || p.client_guide;
                if (u) window.open(u, '_blank', 'noopener');
                else alert('Guide not available');
              });
              tdActions.appendChild(viewGuideBtn);
            }

            const isDelivered = p.status && String(p.status).toLowerCase().includes('delivered');
            const isPaid = p.payment_status && String(p.payment_status).toLowerCase() === 'paid';

            if (isDelivered || isPaid) {
              const previewBtn = document.createElement('button');
              previewBtn.type = 'button';
              previewBtn.textContent = 'Preview';
              previewBtn.addEventListener('click', () => previewSubmission(p.id, p.status, p));
              tdActions.appendChild(previewBtn);

              const openBtn = document.createElement('button');
              openBtn.type = 'button';
              openBtn.textContent = 'Open in new tab';
              openBtn.style.marginLeft = '6px';
              openBtn.addEventListener('click', () => openPreview(p.id, p));
              tdActions.appendChild(openBtn);
            } else {
              // locked state: show notice and Pay button
              const locked = document.createElement('span');
              locked.textContent = 'Locked â€” pay to view';
              locked.style.fontWeight = 'bold';
              locked.style.marginRight = '8px';
              tdActions.appendChild(locked);

              const payActionBtn = document.createElement('button');
              payActionBtn.type = 'button';
              payActionBtn.textContent = 'Pay';
              payActionBtn.style.marginLeft = '6px';
              payActionBtn.addEventListener('click', async () => {
                const phone = prompt('Enter mobile phone number to pay (e.g. 2547XXXXXXXX):', '');
                if (!phone) return alert('Phone number required');
                let amt = (p && p.amount) ? Number(p.amount) : 0;
                if (!amt || amt === 0) {
                  const a = prompt('Enter amount to pay (KES):', '50');
                  if (!a) return alert('Amount required');
                  amt = Number(a);
                }
                payActionBtn.disabled = true;
                try {
                  const resp = await fetch(apiUrl('/api/payments/initiate'), {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: p.id, phoneNumber: phone, amount: amt })
                  });
                  const payload = await safeJson(resp) || {};
                  if (!resp.ok) {
                    alert(payload.message || 'Failed to initiate payment');
                    payActionBtn.disabled = false;
                    return;
                  }
                  alert('Payment initiated. Follow prompts on your phone.');
                  // poll for confirmation
                  const start = Date.now();
                  const poll = async () => {
                    try {
                      const sres = await fetch(apiUrl(`/api/orders/${p.id}/payment-status`));
                      const sdata = await safeJson(sres) || {};
                      if (sdata.payment_status === 'paid') {
                        alert('Payment confirmed â€” download unlocked.');
                        loadProjects();
                        return;
                      }
                      if (Date.now() - start > 60000) {
                        alert('Payment confirmation timed out. Check later.');
                        payActionBtn.disabled = false;
                        return;
                      }
                      setTimeout(poll, 2000);
                    } catch (e) {
                      console.error('Poll error', e);
                      setTimeout(poll, 2000);
                    }
                  };
                  setTimeout(poll, 1500);
                } catch (e) {
                  alert('Payment error: ' + (e.message || e));
                  payActionBtn.disabled = false;
                }
              });
              tdActions.appendChild(payActionBtn);
            }
          } else {
            tdActions.appendChild(document.createTextNode('Not yet submitted'));
          }

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => deleteProject(p.id));
          tdActions.appendChild(deleteBtn);

          tr.appendChild(tdActions);
          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading projects:", err);
        tableBody.innerHTML = `<tr><td colspan="8" class="noOrders">Failed to load projects.</td></tr>`;
      } finally {
        isLoadingProjects = false;
      }
    }

    // submit new project
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const title = document.getElementById("title").value.trim();
        const entryType = document.querySelector('input[name="entryType"]:checked').value;
        const submissionDateVal = document.getElementById("submission_date").value || new Date().toISOString().slice(0,10);
        const expectedVal = document.getElementById("expected_ready").value || null;

        let res, payload;
        // if user chose to upload guide and a file is selected, use FormData
        if (entryType === 'upload' && guideInput && guideInput.files && guideInput.files.length) {
          const fd = new FormData();
          fd.append('title', title);
          fd.append('description', '');
          fd.append('client_id', user.id);
          fd.append('submission_date', submissionDateVal);
          if (expectedVal) fd.append('expected_ready', expectedVal);
          fd.append('guide', guideInput.files[0]);
          res = await fetchApi('/api/orders', {
            method: 'POST',
            body: fd
          });
          payload = await safeJson(res) || {};
        } else {
          const project = {
            title,
            description: document.getElementById("description").value.trim(),
            client_id: user.id,
            status: "Pending",
            submission_date: submissionDateVal,
            expected_ready: expectedVal
          };
          res = await fetchApi('/api/orders', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(project)
          });
          payload = await safeJson(res) || {};
        }

        if (res && res.ok) {
          alert(payload.message || 'âœ… Project submitted successfully!');
          form.reset();
          if (submissionDateInput) submissionDateInput.value = new Date().toISOString().slice(0,10);
          updateEntryMode();
          loadProjects();
        } else {
          alert((payload && payload.message) || `âŒ Failed to submit project. (${res && res.status})`);
        }
      } catch (err) {
        alert('Error submitting project: ' + (err.message || err));
      }
    });

    // preview modal management (accessibility + event cleanup)
    const previewModal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    const previewNotice = document.getElementById('previewNotice');
    const openPreviewTabBtn = document.getElementById('openPreviewTab');
    const closePreviewBtn = document.getElementById('closePreview');
    let currentPreviewUrl = null;
    let previousActiveElement = null;
    let onContextMenuHandler = null;
    let onKeyDownHandler = null;
    const payBtn = document.getElementById('payBtn');

    function openModal() {
      previousActiveElement = document.activeElement;
      previewModal.style.display = 'flex';
      closePreviewBtn.focus();
    }
    function closeModal() {
      previewModal.style.display = 'none';
      previewContent.innerHTML = '';
      previewNotice.textContent = '';
      currentPreviewUrl = null;
      openPreviewTabBtn.style.display = 'none';
      if (payBtn) payBtn.style.display = 'none';
      if (onContextMenuHandler) document.removeEventListener('contextmenu', onContextMenuHandler);
      if (onKeyDownHandler) document.removeEventListener('keydown', onKeyDownHandler);
      if (previousActiveElement && previousActiveElement.focus) previousActiveElement.focus();
    }

    closePreviewBtn.addEventListener('click', closeModal);
    openPreviewTabBtn.addEventListener('click', () => { if (currentPreviewUrl) window.open(currentPreviewUrl, '_blank', 'noopener'); });
    // close on Esc
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && previewModal.style.display === 'flex') closeModal();
    });

    // close details modal
    const closeDetails = document.getElementById('closeDetails');
    if (closeDetails) {
      closeDetails.onclick = () => {
        const m = document.getElementById('detailsModal'); if (m) m.style.display = 'none';
        const db = document.getElementById('detailsBody'); if (db) db.innerHTML = '';
      };
    }

    async function previewSubmission(orderId, status, cached) {
      previewContent.innerHTML = '<p style="text-align:center">Loading preview...</p>';
      previewNotice.textContent = '';
      openModal();

      try {
        // use cached object when available to avoid extra fetch
        let data = cached || null;
        if (!data || !data.submission_file && !data.submission_url) {
          const res = await fetchApi(`/api/submission/${orderId}?userId=${user.id}`);
          data = await safeJson(res) || {};
          if (!res.ok) {
            previewContent.innerHTML = `<p style="color:red">${escapeHtml(data.message || 'Failed to load submission')}</p>`;
            return;
          }
        }

        const previewUrlCandidate = data.previewUrl || data.url || data.submission_file || data.submission_url;
        const resolved = resolveUrl(previewUrlCandidate);
        if (!resolved) {
          previewContent.innerHTML = '<p>No submission available.</p>';
          return;
        }

        // only embed same-origin/apiBase content in iframe for security
        if (isAllowedEmbed(resolved)) {
          const paid = (cached && String(cached.payment_status).toLowerCase() === 'paid') || (data && String(data.payment_status).toLowerCase() === 'paid');
          const delivered = status && String(status).toLowerCase().includes('delivered');

          // If not paid and not delivered, lock the preview and show pay flow
          if (!paid && !delivered) {
            currentPreviewUrl = null;
            openPreviewTabBtn.style.display = 'none';
            previewNotice.textContent = 'This submission is locked. Pay to unlock and view the file.';
            previewContent.innerHTML = '<p style="text-align:center">This submission is locked. Please pay to view the full work.</p>';
            if (payBtn) {
              payBtn.style.display = 'inline-block';
              payBtn.disabled = false;
              payBtn.onclick = async () => {
                const phone = prompt('Enter mobile phone number to pay (e.g. 2547XXXXXXXX):');
                if (!phone) return alert('Phone number required');
                let amt = (cached && cached.amount) ? Number(cached.amount) : (data && data.amount) ? Number(data.amount) : 0;
                if (!amt || amt === 0) {
                  const a = prompt('Enter amount to pay (e.g. 10.00):');
                  if (!a) return alert('Amount required');
                  amt = Number(a);
                }
                payBtn.disabled = true;
                previewNotice.textContent = 'Initiating payment...';
                try {
                  const resp = await fetch(apiUrl('/api/payments/initiate'), {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, phoneNumber: phone, amount: amt })
                  });
                  const payload = await safeJson(resp) || {};
                  if (!resp.ok) {
                    alert(payload.message || 'Failed to initiate payment');
                    payBtn.disabled = false;
                    previewNotice.textContent = 'Payment initiation failed.';
                    return;
                  }
                  previewNotice.textContent = 'Payment initiated. Waiting for confirmation...';
                  // poll for status
                  const start = Date.now();
                  const poll = async () => {
                    try {
                      const sres = await fetch(apiUrl(`/api/orders/${orderId}/payment-status`));
                      const sdata = await safeJson(sres) || {};
                      if (sdata.payment_status === 'paid') {
                        previewNotice.textContent = 'Payment confirmed â€” download unlocked.';
                        payBtn.style.display = 'none';
                        openPreviewTabBtn.style.display = 'inline-block';
                        loadProjects();
                        return;
                      }
                      if (Date.now() - start > 60000) {
                        previewNotice.textContent = 'Payment confirmation timed out. Check later.';
                        payBtn.disabled = false;
                        return;
                      }
                      setTimeout(poll, 2000);
                    } catch (e) {
                      console.error('Poll error', e);
                      setTimeout(poll, 2000);
                    }
                  };
                  setTimeout(poll, 1500);
                } catch (e) {
                  alert('Payment error: ' + (e.message || e));
                  payBtn.disabled = false;
                }
              };
            }
            return;
          }

          // paid or delivered: allow embedding/opening
          currentPreviewUrl = resolved;
          openPreviewTabBtn.style.display = 'inline-block';
          previewNotice.textContent = delivered ? 'Delivered â€” you may download the file.' : 'Preview available.';
          if (payBtn) payBtn.style.display = 'none';

          const lower = resolved.toLowerCase();
          if (lower.endsWith('.pdf')) {
            previewContent.innerHTML = `<iframe src="${resolved}" style="width:100%;height:100%;border:0;" sandbox="allow-same-origin allow-scripts"></iframe>`;
          } else if (/(jpg|jpeg|png|gif)$/.test(lower)) {
            previewContent.innerHTML = `<img src="${resolved}" style="max-width:100%;max-height:100%;user-select:none;pointer-events:none;" alt="Submission preview" />`;
          } else {
            // for other types attempt iframe; if the server blocks embedding the iframe will fail - user can open in new tab
            previewContent.innerHTML = `<iframe src="${resolved}" style="width:100%;height:100%;border:0;" sandbox="allow-same-origin"></iframe>`;
          }

          // temporarily disable right-click and some key combos while preview open
          onContextMenuHandler = (e) => { e.preventDefault(); };
          onKeyDownHandler = (e) => {
            if (e.ctrlKey && ['s','p','c','u','S','P','C','U'].includes(e.key)) { e.preventDefault(); }
          };
          document.addEventListener('contextmenu', onContextMenuHandler);
          document.addEventListener('keydown', onKeyDownHandler);
          return;
        }

        // not allowed to embed -> show message and allow open in new tab
        currentPreviewUrl = resolved;
        previewContent.innerHTML = `<p style="text-align:center">Preview cannot be embedded for this file. Use "Open in new tab".</p>`;
        openPreviewTabBtn.style.display = 'inline-block';
        previewNotice.textContent = 'Open in new tab to view the submission.';
      } catch (err) {
        previewContent.innerHTML = `<p style="color:red">Error: ${escapeHtml(err.message || err)}</p>`;
      }
    }

    async function openPreview(orderId, cached) {
      try {
        let data = cached || null;
        if (!data || !data.submission_file && !data.submission_url) {
          const res = await fetchApi(`/api/submission/${orderId}?userId=${user.id}`);
          data = await safeJson(res) || {};
          if (!res.ok) { alert(data.message || 'No preview or file available'); return; }
        }
        const previewUrlCandidate = data.previewUrl || data.url || data.submission_file || data.submission_url;
        const resolved = resolveUrl(previewUrlCandidate);
        if (!resolved) { alert('No preview or file available'); return; }

        const paid = data && String(data.payment_status).toLowerCase() === 'paid';
        const delivered = data && data.status && String(data.status).toLowerCase().includes('delivered');
        if (!paid && !delivered) {
          if (!confirm('This submission is locked. Would you like to pay now to unlock it?')) return;
          const phone = prompt('Enter mobile phone number to pay (e.g. 2547XXXXXXXX):');
          if (!phone) return alert('Phone number required');
          let amt = (data && data.amount) ? Number(data.amount) : 0;
          if (!amt || amt === 0) {
            const a = prompt('Enter amount to pay (e.g. 10.00):');
            if (!a) return alert('Amount required');
            amt = Number(a);
          }
          try {
            const resp = await fetch(apiUrl('/api/payments/initiate'), {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId, phoneNumber: phone, amount: amt })
            });
            const payload = await safeJson(resp) || {};
            if (!resp.ok) { alert(payload.message || 'Failed to initiate payment'); return; }
            alert('Payment initiated. Follow prompts on your phone.');
            const start = Date.now();
            const poll = async () => {
              try {
                const sres = await fetch(apiUrl(`/api/orders/${orderId}/payment-status`));
                const sdata = await safeJson(sres) || {};
                if (sdata.payment_status === 'paid') {
                  alert('Payment confirmed â€” opening file now.');
                  window.open(resolved, '_blank', 'noopener');
                  loadProjects();
                  return;
                }
                if (Date.now() - start > 60000) { alert('Payment confirmation timed out. Check later.'); return; }
                setTimeout(poll, 2000);
              } catch (e) { console.error('Poll error', e); setTimeout(poll, 2000); }
            };
            setTimeout(poll, 1500);
          } catch (e) { alert('Payment error: ' + (e.message || e)); }
          return;
        }

        // already paid or delivered
        window.open(resolved, '_blank', 'noopener');
      } catch (err) {
        alert('Error opening preview: ' + (err.message || err));
      }
    }

    async function deleteProject(orderId) {
      if (!confirm("Are you sure you want to delete this project? This action cannot be undone.")) return;
      try {
        const res = await fetchApi(`/api/orders/${orderId}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" }
        });
        const data = await safeJson(res) || {};
        if (res.ok) {
          alert(data.message || 'âœ… Project deleted successfully!');
          loadProjects();
        } else {
          alert(data.message || `âŒ Failed to delete project. (${res.status})`);
        }
      } catch (err) {
        alert('Error: ' + (err.message || err));
      }
    }

    // initial load + periodic refresh with cleanup
    loadProjects();
    const refreshInterval = setInterval(loadProjects, 10000);
    window.addEventListener('beforeunload', () => clearInterval(refreshInterval));
  </script>
</body>
</html>
