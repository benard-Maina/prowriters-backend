<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | ProWriter</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 0;
    }
    main.dashboard {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1, h2 { color: #333; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #0056b3; }
    .logout { float: right; background: crimson; }
    input, select, textarea {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      margin: 5px 0 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      border-bottom: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
    }
    tr:nth-child(even) { background: #f9f9f9; }
    .status {
      padding: 3px 7px;
      border-radius: 5px;
      color: #fff;
      font-weight: bold;
      font-size: 13px;
    }
    .pending { background: orange; }
    .inprogress { background: #007bff; }
    .submitted { background: purple; }
    .delivered { background: green; }
    .form-section {
      background: #fdfdfd;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      margin-top: 25px;
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover { background: #b52d3a; }
    .submission-link {
      color: #007bff;
      text-decoration: none;
    }
    .submission-link:hover {
      text-decoration: underline;
    }
    .approve-btn {
      background: green;
    }
    .approve-btn:hover {
      background: darkgreen;
    }
  </style>
</head>
<body>
  <main class="dashboard">
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <h1>ðŸ§¾ Admin Dashboard</h1>
      <div class="profile" style="position:relative;">
        <button id="profileBtn" title="Profile" style="width:40px;height:40px;border-radius:50%;border:none;background:#007bff;color:#fff;font-weight:bold;cursor:pointer;">A</button>
        <div id="profileDropdown" style="display:none;position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);min-width:160px;z-index:1000;overflow:hidden;">
          <div id="profileDetailsBtn" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;">Details</div>
          <div id="profileLogout" style="padding:10px 12px;cursor:pointer;color:#fff;background:crimson;text-align:center;">Logout</div>
        </div>
      </div>
    </header>
    <p id="info"></p>

    <!-- ðŸ‘¥ PENDING APPROVAL USERS -->
    <section class="form-section">
      <h2>Pending Approvals</h2>
      <table id="pendingUsersTable">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Country</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- âœ… APPROVED USERS -->
    <section class="form-section">
      <h2>Approved Users</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Country</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ðŸ“ ORDER / PROJECT MANAGEMENT -->
    <section class="form-section">
      <h2>Create New Order / Project</h2>
      <form id="orderForm">
        <input type="text" id="title" placeholder="Title" required />
        <textarea id="description" placeholder="Description" rows="3" required></textarea>
        <input type="number" id="client_id" placeholder="Client ID" required />
        <button type="submit">Add Order</button>
      </form>
    </section>

    <!-- ðŸ“œ ALL ORDERS -->
    <section>
      <h2>All Orders / Projects</h2>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>ID</th><th>Title</th><th>Description</th><th>Client</th><th>Writer</th><th>Status</th><th>Submission</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    // If this page was opened via the filesystem (file://), redirect to the server URL
    if (window.location && window.location.protocol === 'file:') {
      window.location.href = 'http://localhost:3000/admin-dashboard.html';
    }

    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    const authHeaders = token ? { 'Authorization': `Bearer ${token}` } : {};
    const apiBase = (window.location && window.location.origin && window.location.origin.startsWith('http'))
      ? window.location.origin
      : 'http://localhost:3000';
    const apiUrl = (p) => `${apiBase}${p}`;

    if (!user) {
      window.location.href = 'login.html';
    } else if (!user.role || user.role !== 'admin') {
      const role = user && user.role ? user.role : null;
      const allowed = ['admin', 'writer', 'client'];
      if (!role || !allowed.includes(role)) {
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      } else {
        window.location.href = `${role}-dashboard.html`;
      }
    }

    document.getElementById('info').textContent = `Welcome, ${user.name} (${user.role})`;

    // Profile dropdown and logout handling
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn && user && user.name) {
      const initials = user.name.split(' ').map(n => n && n[0]).filter(Boolean).slice(0,2).join('').toUpperCase();
      profileBtn.textContent = initials || 'A';
    }
    const profileDropdown = document.getElementById('profileDropdown');
    function closeProfileDropdown() { profileDropdown.style.display = 'none'; }

    profileBtn && profileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      profileDropdown.style.display = (profileDropdown.style.display === 'block') ? 'none' : 'block';
    });

    // Close when clicking outside
    document.addEventListener('click', () => closeProfileDropdown());

    // Details button opens a modal with user info
    const profileDetailsBtn = document.getElementById('profileDetailsBtn');
    const profileLogoutBtn = document.getElementById('profileLogout');

    profileDetailsBtn && profileDetailsBtn.addEventListener('click', () => {
      const modal = document.getElementById('detailsModal');
      const body = document.getElementById('detailsBody');
      if (modal && body) {
        body.innerHTML = `
          <p><strong>Name:</strong> ${user.name || 'â€”'}</p>
          <p><strong>Email:</strong> ${user.email || 'â€”'}</p>
          <p><strong>Role:</strong> ${user.role || 'â€”'}</p>
          <p><strong>ID:</strong> ${user.id || 'â€”'}</p>
          <p><strong>Country:</strong> ${user.country || 'â€”'}</p>
        `;
        modal.style.display = 'flex';
      }
      closeProfileDropdown();
    });

    // Logout from dropdown
    profileLogoutBtn && profileLogoutBtn.addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    });

    // ðŸ”¹ Load Pending Users
    async function loadPendingUsers() {
      const res = await fetch(apiUrl('/api/pending-users'), { headers: { ...authHeaders } });
      const users = await res.json();
      const tbody = document.querySelector('#pendingUsersTable tbody');
      tbody.innerHTML = users.length
        ? users.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>${u.country || 'â€”'}</td>
            <td><button class="approve-btn" onclick="approveUser(${u.id})">Approve</button></td>
          </tr>
        `).join('')
        : `<tr><td colspan="6" style="text-align:center;">No pending users</td></tr>`;
    }

    // âœ… Approve User
    async function approveUser(id) {
      if (!confirm('Approve this user?')) return;
      const res = await fetch(apiUrl(`/api/approve-user/${id}`), { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders } });
      const data = await res.json();
      alert(data.message);
      loadPendingUsers();
      loadUsers();
    }

    // ðŸ”¹ Load Approved Users
    async function loadUsers() {
      try {
        const res = await fetch(apiUrl('/api/users'), { headers: { ...authHeaders } });
        const users = await res.json();
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = users.length
          ? users.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${u.name}</td>
              <td>${u.email}</td>
              <td>${u.role}</td>
              <td>${u.country || 'â€”'}</td>
              <td><button class="delete-btn" onclick="deleteUser(${u.id})">Delete</button></td>
            </tr>
          `).join('')
          : `<tr><td colspan="6" style="text-align:center;">No approved users</td></tr>`;
      } catch (err) {
        console.error('Failed to load users', err);
      }
    }

    // Delete user
    async function deleteUser(id) {
      if (!confirm('Delete this user?')) return;
      try {
        const res = await fetch(apiUrl(`/api/users/${id}`), { method: 'DELETE', headers: { ...authHeaders } });
        const data = await res.json();
        alert(data.message);
        loadUsers();
      } catch (err) {
        console.error('Failed to delete user', err);
        alert('Failed to delete user.');
      }
    }

    // ðŸ”¹ Load Orders
    async function loadOrders() {
      try {
        const res = await fetch(apiUrl('/api/orders'), { headers: { ...authHeaders } });
        let orders = [];
        try { orders = await res.json(); } catch (e) { console.error('Failed to parse /api/orders', e); }
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '';

        if (!Array.isArray(orders) || orders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:gray;">No orders yet</td></tr>`;
          return;
        }

        orders.forEach(order => {
          const statusClass = (order.status || '').toLowerCase().replace(/ /g, '');
          const tr = document.createElement('tr');
          const submissionPath = order.submission_file || order.submission_path || order.submission || '';
          const submissionHtml = submissionPath
            ? `<a href="${submissionPath}" target="_blank" class="submission-link">View File</a>`
            : 'No Submission';

          tr.innerHTML = `
            <td>${order.id}</td>
            <td>${order.title}</td>
            <td>${order.description}</td>
            <td>${order.client_name || 'â€”'}</td>
            <td>${order.writer_name || 'Unassigned'}</td>
            <td><span class="status ${statusClass}">${order.status || ''}</span></td>
            <td>${submissionHtml}</td>
              <td>
                <button onclick="assignWriter(${order.id})">Assign Writer</button>
                <button onclick="markDelivered(${order.id})">Send to Client</button>
                ${submissionPath ? `<button onclick="previewSubmission(${order.id})">Preview</button>` : ''}
                <button onclick="editOrder(${order.id})">Edit</button>
                <button class="delete-btn" onclick="deleteOrder(${order.id})">Delete</button>
              </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Failed to load orders', err);
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:gray;">Failed to load orders</td></tr>`;
      }
    }

    // Assign writer
    async function assignWriter(orderId) {
      const writerId = prompt("Enter Writer ID to assign:");
      if (!writerId) return;
      const res = await fetch(apiUrl('/api/assign'), {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders },
        body: JSON.stringify({ orderId, writerId })
      });
      const data = await res.json();
      alert(data.message);
      loadOrders();
    }

    // Send to client
    async function markDelivered(orderId) {
      if (!confirm("Deliver this work to client?")) return;
      const res = await fetch(apiUrl(`/api/send-to-client/${orderId}`), { method: "POST", headers: {'Content-Type':'application/json', ...authHeaders} });
      const data = await res.json();
      alert(data.message);
      loadOrders();
    }

    // Delete order
    async function deleteOrder(id) {
      if (!confirm('Delete this order?')) return;
      const res = await fetch(apiUrl(`/api/orders/${id}`), { method: 'DELETE', headers: { ...authHeaders } });
      const data = await res.json();
      alert(data.message);
      loadOrders();
    }

    // Add Order
    document.getElementById('orderForm').addEventListener('submit', async e => {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const client_id = document.getElementById('client_id').value;

      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title, description, client_id })
      });
      const data = await res.json();
      alert(data.message);
      e.target.reset();
      loadOrders();
    });

    // Load all on start
    loadPendingUsers();
    loadOrders();
    loadUsers();
  </script>
  <!-- Details Modal -->
  <div id="detailsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; padding:16px; max-width:420px; width:90%; border-radius:8px; position:relative;">
      <button id="closeDetails" style="position:absolute; right:12px; top:12px; background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Close</button>
      <h3 style="margin-top:0;">Profile Details</h3>
      <div id="detailsBody" style="margin-top:8px; color:#333;"></div>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="editOrderModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:10000;">
    <div style="background:#fff; padding:16px; max-width:560px; width:95%; border-radius:8px; position:relative;">
      <button id="closeEdit" style="position:absolute; right:12px; top:12px; background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Close</button>
      <h3 style="margin-top:0;">Edit Order</h3>
      <form id="editOrderForm">
        <input type="hidden" id="editOrderId">
        <label>Title</label>
        <input id="editTitle" required />
        <label>Description</label>
        <textarea id="editDescription" rows="3" required></textarea>
        <label>Client ID</label>
        <input id="editClientId" type="number" />
        <label>Writer ID</label>
        <input id="editWriterId" type="number" />
        <label>Status</label>
        <input id="editStatus" />
        <label>Amount (KES)</label>
        <input id="editAmount" type="number" step="0.01" />
        <label>Payment Status</label>
        <select id="editPaymentStatus">
          <option value="unpaid">unpaid</option>
          <option value="pending">pending</option>
          <option value="paid">paid</option>
        </select>
        <div style="margin-top:12px;display:flex;gap:8px;">
          <button type="submit" style="flex:1;">Save Changes</button>
          <button type="button" id="cancelEdit" style="flex:1;background:#6c757d;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;">
    <div id="previewContent" style="background:#fff; padding:16px; max-width:90%; max-height:90%; overflow:auto; border-radius:8px;">
      <button id="closePreview" style="float:right;background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Close</button>
      <div id="previewBody" style="clear:both; margin-top:8px;"></div>
    </div>
  </div>

  <script>
    async function previewSubmission(orderId) {
      const modal = document.getElementById('previewModal');
      const body = document.getElementById('previewBody');
      body.innerHTML = 'Loading preview...';
      modal.style.display = 'flex';

      try {
        const res = await fetch(apiUrl(`/api/submission/${orderId}`), { headers: { ...authHeaders } });
        let data = {};
        try { data = await res.json(); } catch (e) { data = {}; }
        if (!res.ok) {
          body.innerHTML = `<p style="color:red">${data.message || 'Failed to load submission'}</p>`;
          return;
        }

        const url = data.url || data.submission_file;
        if (!url) {
          body.innerHTML = '<p>No submission available.</p>';
          return;
        }

        // Build absolute URL for the resource
        const base = (window.location && window.location.origin && window.location.origin.startsWith('http'))
          ? window.location.origin
          : (apiBase || 'http://localhost:3000');

        const fullUrl = url.startsWith('http') ? url : (url.startsWith('/') ? `${base}${url}` : `${base}/${url}`);
        const lower = fullUrl.toLowerCase();

        if (lower.endsWith('.pdf')) {
          body.innerHTML = `<iframe src="${fullUrl}" style="width:100%;height:70vh;border:0"></iframe>`;
        } else if (/(jpg|jpeg|png|gif)$/.test(lower)) {
          body.innerHTML = `<img src="${fullUrl}" style="max-width:100%;height:auto;" />`;
        } else {
          // For other file types provide a direct link to open/download
          body.innerHTML = `<p>File: <a href="${fullUrl}" target="_blank" rel="noopener">Open submission</a></p>`;
        }
      } catch (err) {
        body.innerHTML = `<p style="color:red">Error: ${err.message || err}</p>`;
      }
    }

    document.getElementById('closePreview').onclick = () => {
      document.getElementById('previewModal').style.display = 'none';
      document.getElementById('previewBody').innerHTML = '';
    };

    const closeDetails = document.getElementById('closeDetails');
    if (closeDetails) {
      closeDetails.onclick = () => {
        const m = document.getElementById('detailsModal');
        if (m) m.style.display = 'none';
        document.getElementById('detailsBody').innerHTML = '';
      };
    }

    // ========================== âœï¸ Edit Order ==========================
    function editOrder(orderId) {
      const modal = document.getElementById('editOrderModal');
      const idInput = document.getElementById('editOrderId');
      const title = document.getElementById('editTitle');
      const desc = document.getElementById('editDescription');
      const clientInp = document.getElementById('editClientId');
      const writerInp = document.getElementById('editWriterId');
      const statusInp = document.getElementById('editStatus');
      const amountInp = document.getElementById('editAmount');
      const payStatus = document.getElementById('editPaymentStatus');
      // fetch order details
      fetch(apiUrl(`/api/orders`), { headers: { ...authHeaders } }).then(r => r.json()).then(list => {
        const ord = (list || []).find(o => Number(o.id) === Number(orderId));
        if (!ord) return alert('Order not found');
        idInput.value = ord.id;
        title.value = ord.title || '';
        desc.value = ord.description || '';
        clientInp.value = ord.client_id || '';
        writerInp.value = ord.writer_id || '';
        statusInp.value = ord.status || '';
        amountInp.value = ord.amount || '';
        payStatus.value = ord.payment_status || 'unpaid';
        modal.style.display = 'flex';
      }).catch(e => { console.error(e); alert('Failed to load order'); });
    }

    document.getElementById('closeEdit').addEventListener('click', () => { document.getElementById('editOrderModal').style.display = 'none'; });
    document.getElementById('cancelEdit').addEventListener('click', () => { document.getElementById('editOrderModal').style.display = 'none'; });

    document.getElementById('editOrderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editOrderId').value;
      const payload = {
        title: document.getElementById('editTitle').value.trim(),
        description: document.getElementById('editDescription').value.trim(),
        client_id: Number(document.getElementById('editClientId').value) || null,
        writer_id: Number(document.getElementById('editWriterId').value) || null,
        status: document.getElementById('editStatus').value.trim(),
        amount: Number(document.getElementById('editAmount').value) || 0,
        payment_status: document.getElementById('editPaymentStatus').value
      };
      try {
        const res = await fetch(apiUrl(`/api/orders/${id}`), { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!res.ok) return alert(data.message || 'Failed to update order');
        alert('Order updated');
        document.getElementById('editOrderModal').style.display = 'none';
        loadOrders();
      } catch (err) {
        console.error(err);
        alert('Update failed');
      }
    });
  </script>
</body>
</html>
